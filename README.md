# Realtime Chat å®æ—¶è‡ªæ¯èŠå¤©åº”ç”¨

> æœ¬é¡¹ç›®æ˜¯åŸºäº [joschan21/nextjs16_realtime_chat](https://github.com/joschan21/nextjs16_realtime_chat) çš„å¤åˆ»ç‰ˆæœ¬ï¼Œæ„Ÿè°¢åŸä½œè€…çš„å¼€æºè´¡çŒ®ã€‚

ä¸€ä¸ªåŸºäº Next.js çš„å®æ—¶è‡ªæ¯èŠå¤©åº”ç”¨ï¼Œæä¾›ç§å¯†ã€å®‰å…¨çš„å³æ—¶é€šè®¯ä½“éªŒã€‚æˆ¿é—´å…·æœ‰è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼Œæ‰€æœ‰æ¶ˆæ¯åœ¨æˆ¿é—´è¿‡æœŸæˆ–è¢«é”€æ¯åæ°¸ä¹…åˆ é™¤ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ”’ **ç§å¯†èŠå¤©** - åˆ›å»ºå®‰å…¨çš„èŠå¤©æˆ¿é—´ï¼Œä¿æŠ¤ç”¨æˆ·éšç§
- â° **è‡ªåŠ¨è¿‡æœŸ** - æˆ¿é—´é»˜è®¤ 10 åˆ†é’Ÿåè‡ªåŠ¨é”€æ¯ï¼Œæ‰€æœ‰æ¶ˆæ¯æ°¸ä¹…åˆ é™¤
- ğŸ“¡ **å®æ—¶é€šä¿¡** - åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€
- ğŸ‘¤ **åŒ¿åèº«ä»½** - è‡ªåŠ¨ç”ŸæˆåŒ¿åç”¨æˆ·åï¼Œæ— éœ€æ³¨å†Œ
- ğŸ“± **å“åº”å¼è®¾è®¡** - å®Œç¾é€‚é…æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
- ğŸ¨ **ç°ä»£ UI** - ä½¿ç”¨ Tailwind CSS æ„å»ºçš„æ·±è‰²ä¸»é¢˜ç•Œé¢
- ğŸ—‘ï¸ **æ‰‹åŠ¨é”€æ¯** - æ”¯æŒéšæ—¶æ‰‹åŠ¨é”€æ¯æˆ¿é—´

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### å‰ç«¯
- **Next.js 16** - React æ¡†æ¶
- **React 19** - UI åº“
- **TypeScript** - ç±»å‹å®‰å…¨
- **Tailwind CSS 4** - æ ·å¼æ¡†æ¶
- **@tanstack/react-query** - æ•°æ®è·å–å’ŒçŠ¶æ€ç®¡ç†
- **@upstash/realtime** - å®æ—¶é€šä¿¡å®¢æˆ·ç«¯

### åç«¯
- **Elysia** - é«˜æ€§èƒ½ API æ¡†æ¶
- **@upstash/redis** - Redis æ•°æ®åº“å®¢æˆ·ç«¯
- **@upstash/realtime** - å®æ—¶é€šä¿¡æœåŠ¡
- **Zod** - æ•°æ®éªŒè¯

### å¼€å‘å·¥å…·
- **ESLint** - ä»£ç æ£€æŸ¥
- **PostCSS** - CSS å¤„ç†
- **Babel React Compiler** - React ç¼–è¯‘å™¨ä¼˜åŒ–

## ğŸ“¦ å®‰è£…

### å‰ç½®è¦æ±‚

- Node.js 18+ 
- npm / yarn / pnpm / bun
- [Upstash Redis](https://upstash.com/) è´¦å·

### ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env.local` æ–‡ä»¶å¹¶é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```env
UPSTASH_REDIS_REST_URL=your_redis_url
UPSTASH_REDIS_REST_TOKEN=your_redis_token
```

è·å– Upstash Redis å‡­è¯ï¼š
1. è®¿é—® [Upstash Console](https://console.upstash.com/)
2. åˆ›å»ºæ–°çš„ Redis æ•°æ®åº“
3. å¤åˆ¶ REST URL å’Œ Token åˆ° `.env.local`

### å®‰è£…ä¾èµ–

```bash
npm install
# æˆ–
yarn install
# æˆ–
pnpm install
# æˆ–
bun install
```

## ğŸš€ ä½¿ç”¨

### å¼€å‘æ¨¡å¼

å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š

```bash
npm run dev
# æˆ–
yarn dev
# æˆ–
pnpm dev
# æˆ–
bun dev
```

æ‰“å¼€ [http://localhost:3000](http://localhost:3000) æŸ¥çœ‹åº”ç”¨ã€‚

### ç”Ÿäº§æ„å»º

æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼š

```bash
npm run build
```

å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨ï¼š

```bash
npm start
```

### ä»£ç æ£€æŸ¥

è¿è¡Œ ESLint æ£€æŸ¥ä»£ç ï¼š

```bash
npm run lint
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
realtime_chat/
â”œâ”€â”€ public/                 # é™æ€èµ„æº
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ [[...slugs]]/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts          # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts         # API è·¯ç”±
â”‚   â”‚   â”‚   â””â”€â”€ realtime/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts         # å®æ—¶é€šä¿¡ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ room/
â”‚   â”‚   â”‚   â””â”€â”€ [roomId]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx         # èŠå¤©æˆ¿é—´é¡µé¢
â”‚   â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”‚   â”œâ”€â”€ globals.css              # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ layout.tsx               # æ ¹å¸ƒå±€
â”‚   â”‚   â””â”€â”€ page.tsx                 # é¦–é¡µï¼ˆå¤§å…ï¼‰
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ providers.tsx            # React Query å’Œ Realtime Provider
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ use-username.ts          # ç”¨æˆ·å Hook
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ client.ts                # API å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ realtime-client.ts       # å®æ—¶é€šä¿¡å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ realtime.ts              # å®æ—¶é€šä¿¡é…ç½®
â”‚       â””â”€â”€ redis.ts                 # Redis å®¢æˆ·ç«¯
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ bun.lock
â”œâ”€â”€ eslint.config.mjs
â”œâ”€â”€ next.config.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ postcss.config.mjs
â””â”€â”€ tsconfig.json
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### æˆ¿é—´ç®¡ç†

- **åˆ›å»ºæˆ¿é—´**: ç”Ÿæˆå”¯ä¸€çš„æˆ¿é—´ ID
- **æˆ¿é—´è¿‡æœŸ**: é»˜è®¤ 10 åˆ†é’Ÿåè‡ªåŠ¨é”€æ¯
- **æ‰‹åŠ¨é”€æ¯**: ç”¨æˆ·å¯éšæ—¶é”€æ¯æˆ¿é—´
- **TTL æŸ¥è¯¢**: å®æ—¶æ˜¾ç¤ºå‰©ä½™æ—¶é—´

### æ¶ˆæ¯åŠŸèƒ½

- **å‘é€æ¶ˆæ¯**: æ”¯æŒæ–‡æœ¬æ¶ˆæ¯ï¼ˆæœ€å¤š 1000 å­—ç¬¦ï¼‰
- **å®æ—¶æ¥æ”¶**: åŸºäº WebSocket çš„å®æ—¶æ¨é€
- **æ¶ˆæ¯å†å²**: è‡ªåŠ¨ä¿å­˜å’ŒåŠ è½½æ¶ˆæ¯è®°å½•
- **æ—¶é—´æˆ³**: æ˜¾ç¤ºæ¶ˆæ¯å‘é€æ—¶é—´

### ç”¨æˆ·èº«ä»½

- **åŒ¿åç”¨æˆ·**: è‡ªåŠ¨ç”ŸæˆåŒ¿åç”¨æˆ·å
- **æœ¬åœ°å­˜å‚¨**: ç”¨æˆ·åä¿å­˜åœ¨ localStorage
- **èº«ä»½æ ‡è¯†**: æ¯ä¸ªç”¨æˆ·æœ‰å”¯ä¸€çš„èº«ä»½ ID

## ğŸ”Œ API æ¥å£

### æˆ¿é—´ç›¸å…³

#### åˆ›å»ºæˆ¿é—´
```
POST /api/room/create
```
å“åº”:
```json
{
  "roomId": "unique-room-id"
}
```

#### è·å–æˆ¿é—´å‰©ä½™æ—¶é—´
```
GET /api/room/ttl?roomId=xxx
```
å“åº”:
```json
{
  "ttl": 600
}
```

#### é”€æ¯æˆ¿é—´
```
DELETE /api/room?roomId=xxx
```

### æ¶ˆæ¯ç›¸å…³

#### å‘é€æ¶ˆæ¯
```
POST /api/messages?roomId=xxx
```
è¯·æ±‚ä½“:
```json
{
  "sender": "username",
  "text": "message content"
}
```

#### è·å–æ¶ˆæ¯å†å²
```
GET /api/messages?roomId=xxx
```
å“åº”:
```json
{
  "messages": [
    {
      "id": "msg-id",
      "sender": "username",
      "text": "message",
      "timestamp": 1234567890,
      "roomId": "room-id"
    }
  ]
}
```

### å®æ—¶é€šä¿¡

#### WebSocket è¿æ¥
```
GET /api/realtime
```

äº‹ä»¶:
- `chat.message` - æ–°æ¶ˆæ¯
- `chat.destroy` - æˆ¿é—´é”€æ¯

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **Token è®¤è¯**: æ¯ä¸ªæˆ¿é—´è¿æ¥éœ€è¦æœ‰æ•ˆçš„ token
- **æˆ¿é—´éš”ç¦»**: ä¸åŒæˆ¿é—´çš„æ¶ˆæ¯å®Œå…¨éš”ç¦»
- **è‡ªåŠ¨æ¸…ç†**: è¿‡æœŸæ•°æ®è‡ªåŠ¨åˆ é™¤
- **è¾“å…¥éªŒè¯**: ä½¿ç”¨ Zod è¿›è¡Œä¸¥æ ¼çš„æ•°æ®éªŒè¯

## ğŸ¨ UI ç‰¹æ€§

- **æ·±è‰²ä¸»é¢˜**: æŠ¤çœ¼çš„æ·±è‰²ç•Œé¢
- **å“åº”å¼å¸ƒå±€**: è‡ªé€‚åº”å„ç§å±å¹•å°ºå¯¸
- **å®æ—¶å€’è®¡æ—¶**: æ˜¾ç¤ºæˆ¿é—´å‰©ä½™æ—¶é—´
- **æ¶ˆæ¯åŒºåˆ†**: åŒºåˆ†è‡ªå·±å’Œä»–äººæ¶ˆæ¯
- **å¤åˆ¶é“¾æ¥**: ä¸€é”®å¤åˆ¶æˆ¿é—´é“¾æ¥

## ğŸ“ é…ç½®è¯´æ˜

### ä¿®æ”¹æˆ¿é—´è¿‡æœŸæ—¶é—´

ç¼–è¾‘ `src/app/api/[[...slugs]]/route.ts`:

```typescript
const ROOM_TTL_SECONDS = 6 * 10; // ä¿®æ”¹ä¸ºæ‰€éœ€çš„ç§’æ•°
```

### ä¿®æ”¹æ¶ˆæ¯é™åˆ¶

ç¼–è¾‘ `src/app/api/[[...slugs]]/route.ts`:

```typescript
body: z.object({
  sender: z.string().max(100),  // ä¿®æ”¹å‘é€è€…åç§°æœ€å¤§é•¿åº¦
  text: z.string().max(1000),   // ä¿®æ”¹æ¶ˆæ¯æœ€å¤§é•¿åº¦
}),
```

## ğŸš€ éƒ¨ç½²

### Vercel éƒ¨ç½²

1. å°†ä»£ç æ¨é€åˆ° GitHub
2. åœ¨ Vercel å¯¼å…¥é¡¹ç›®
3. é…ç½®ç¯å¢ƒå˜é‡
4. éƒ¨ç½²å®Œæˆ

### å…¶ä»–å¹³å°

é¡¹ç›®å¯éƒ¨ç½²åˆ°ä»»ä½•æ”¯æŒ Next.js çš„å¹³å°ï¼š
- Vercel
- Netlify
- Railway
- Render
- è‡ªæ‰˜ç®¡æœåŠ¡å™¨

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ”— ç›¸å…³é“¾æ¥

- [Next.js æ–‡æ¡£](https://nextjs.org/docs)
- [Upstash æ–‡æ¡£](https://upstash.com/docs)
- [Elysia æ–‡æ¡£](https://elysiajs.com/)
- [Tailwind CSS æ–‡æ¡£](https://tailwindcss.com/docs)
- [React Query æ–‡æ¡£](https://tanstack.com/query/latest)

## ğŸ’¡ ä½¿ç”¨æç¤º

1. **æˆ¿é—´é“¾æ¥**: åˆ›å»ºæˆ¿é—´åï¼Œå¤åˆ¶é“¾æ¥åˆ†äº«ç»™å…¶ä»–ç”¨æˆ·
2. **æ—¶é—´é™åˆ¶**: æ³¨æ„æˆ¿é—´å‰©ä½™æ—¶é—´ï¼ŒåŠæ—¶ä¿å­˜é‡è¦ä¿¡æ¯
3. **å¤šè®¾å¤‡**: åŒä¸€ç”¨æˆ·å¯åœ¨å¤šä¸ªè®¾å¤‡åŒæ—¶ç™»å½•
4. **éšç§ä¿æŠ¤**: æˆ¿é—´é”€æ¯åï¼Œæ‰€æœ‰æ•°æ®æ— æ³•æ¢å¤

## ğŸ› å·²çŸ¥é—®é¢˜

- æˆ¿é—´è¿‡æœŸåï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- ç½‘ç»œæ–­å¼€åï¼Œéœ€è¦é‡æ–°è¿æ¥æˆ¿é—´

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿é€šè¿‡ Issue è”ç³»ã€‚

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®å¤åˆ»è‡ª [joschan21/nextjs16_realtime_chat](https://github.com/joschan21/nextjs16_realtime_chat)ï¼Œæ„Ÿè°¢åŸä½œè€… joschan21 çš„å¼€æºè´¡çŒ®å’Œä¼˜ç§€è®¾è®¡ã€‚
